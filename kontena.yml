pg:
  image: 'postgres:9.4'
  stateful: true
  log_driver: syslog
  log_opt:
    tag: '{{.Name}}'

redis:
  image: 'redis:3-alpine'
  command: 'redis-server --appendonly yes'
  stateful: true
  log_driver: syslog
  log_opt:
    tag: '{{.Name}}'

app:
  image: shiplix/shiplix
  build: '.'
  dockerfile: config/docker/production/rails/Dockerfile
  command: ./config/docker/production/rails/unicorn.sh
  environment:
    - KONTENA_LB_INTERNAL_PORT=3000
    - SHIPLIX_DB_HOST=shiplix-pg
    - SHIPLIX_REDIS_HOST=shiplix-redis
  secrets:
    - secret: SHIPLIX_LB_HOSTS
      name: KONTENA_LB_VIRTUAL_HOSTS
      type: env
    - secret: SHIPLIX_HOST
      name: SHIPLIX_HOST
      type: env
    - secret: SHIPLIX_GITHUB_SECRET_TOKEN
      name: GITHUB_SECRET_TOKEN
      type: env
    - secret: SHIPLIX_GITHUB_CLIENT_ID
      name: SHIPLIX_GITHUB_CLIENT_ID
      type: env
    - secret: SHIPLIX_GITHUB_CLIENT_SECRET
      name: SHIPLIX_GITHUB_CLIENT_SECRET
      type: env
    - secret: SHIPLIX_SECRET_KEY_BASE
      name: SHIPLIX_SECRET_KEY_BASE
      type: env
    - secret: SHIPLIX_NEWRELIC_KEY
      name: SHIPLIX_NEWRELIC_KEY
      type: env
    - secret: SHIPLIX_NEWRELIC_APP_NAME
      name: SHIPLIX_NEWRELIC_APP_NAME
      type: env
  external_links:
    - lb
  log_driver: syslog
  log_opt:
    tag: '{{.Name}}'

worker:
  image: shiplix/shiplix
  command: 'bundle exec rake resque:work --trace'
  environment:
    - 'QUEUE=*'
    - SHIPLIX_DB_HOST=shiplix-pg
    - SHIPLIX_REDIS_HOST=shiplix-redis
  secrets:
    - secret: SHIPLIX_HOST
      name: SHIPLIX_HOST
      type: env
    - secret: GITHUB_SECRET_TOKEN
      name: GITHUB_SECRET_TOKEN
      type: env
    - secret: SHIPLIX_GITHUB_CLIENT_ID
      name: SHIPLIX_GITHUB_CLIENT_ID
      type: env
    - secret: SHIPLIX_GITHUB_CLIENT_SECRET
      name: SHIPLIX_GITHUB_CLIENT_SECRET
      type: env
    - secret: SHIPLIX_SECRET_KEY_BASE
      name: SHIPLIX_SECRET_KEY_BASE
      type: env
    - secret: SHIPLIX_NEWRELIC_KEY
      name: SHIPLIX_NEWRELIC_KEY
      type: env
    - secret: SHIPLIX_NEWRELIC_APP_NAME
      name: SHIPLIX_NEWRELIC_APP_NAME
      type: env
  volumes:
    - '/tmp/builds:/app/tmp/builds'
  log_driver: syslog
  log_opt:
    tag: '{{.Name}}'
